# Development Dockerfile with hot reload
# Build context: workspace root (dev_digest_tracker/)
FROM node:20-alpine

RUN apk add --no-cache libc6-compat git
WORKDIR /app

# Install pnpm
RUN corepack enable && corepack prepare pnpm@10.29.3 --activate

# Copy workspace root manifests
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml .npmrc ./
# Copy web app package.json
COPY apps/web/package.json ./apps/web/package.json

# Install dependencies (skip lifecycle scripts like lefthook that don't apply in Docker)
RUN pnpm install --frozen-lockfile --ignore-scripts --filter @devdigest/web...

# Copy prisma schema and generate client
COPY apps/web/prisma ./apps/web/prisma
RUN pnpm --filter @devdigest/web db:generate

EXPOSE 3000

# Generate Prisma client for container platform, then run dev server
CMD ["sh", "-c", "pnpm --filter @devdigest/web db:generate && pnpm --filter @devdigest/web dev"]
